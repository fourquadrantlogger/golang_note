## 栈初始化

+ 主协程初始化

Golang的主协程指的是运行main函数的协程，而子协程指的是在程序运行过程中由主协程创建的协程。每个线程(m)只会有一个主协程，而子协程可能会有很多很多。
子协程和主协程在概念和内部实现上几乎没有任何区别，唯一的不同在于它们的初始栈大小不同。
我们先看看测试过程中生成的主协程堆栈示例。我测试代码中就生成了一个主协程，通过反汇编代码看到他的样子大概如下：

在go1.5.1版本中，_StackMin大小被定义为2048(而在1.3.2版本中该值还是8192)，也即每个协程的初始堆栈大小为2KB，相当小了。缩小该值的好处是即使创建了很多的协程也不会导致内存使用的急剧增长。
另外，在协程栈空间被分配出来后，还需要作一些其他的初始化，主要是协程栈顶的设置以及堆栈保护的设置。
栈顶的设置方法比较简单，将当前栈的起始地址减去参数占用的空间即可(注意栈是从高地址向低地址延伸的)。
栈保护的设置指的是设置一个临界点，当sp到达该临界点时认为栈空间可能会不足，需要进行栈扩容。当前版本的协程栈保护大小事640B。

## 堆栈扩容

+ 栈扩容

协程堆栈扩容

协程栈详细布局

我们前面说到，在创建一个协程时就为其创建了一个初始的栈，用来执行函数调用。协程栈的大概布局情况如下：


+ 栈空间扩容

对协程的栈进行扩容必然是原有堆栈空间不足，因此，我们首先需要切换到该线程的堆栈上来调用扩容函数。否则就变成了鸡生蛋和蛋生鸡的问题了：要调用新函数来进行栈扩容，而调用新函数又需要新的栈。
其次，在新的栈空间申请成功后，我们还需要将现有栈的内容全部拷贝过去。拷贝完成后还得继续现有的函数流程走下去(我们需要能够从线程堆栈切换回协程堆栈)。因此，在调用扩容函数时需要将一些当前的运行环境保存下来。